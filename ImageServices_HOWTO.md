# Конфигурация сервисов для генерации изображений

Встроенные команды `image_generation.*`/`images.*` в Harmony должны
использоваться только тогда, когда:

1. Загружена мультимодальная модель (умеет генерировать/редактировать изображения), **или**
2. Задан внешний сервис через `--image-service-config`.

Без этих условий vLLM теперь блокирует вызов и возвращает `response.error`
с сообщением «Image generation tools are disabled…».

## 1. Готовим конфигурацию внешнего API

1. Скопируйте файл-шаблон `image_service_config.template.json` в новое место,
   например `config/image_service.json`.
2. Заполните поля:
   - `provider` — произвольное имя сервиса (используется только в логах);
   - `api_base` — базовый URL API (`https://.../v1`);
   - `api_key_env` — имя переменной окружения, в которой будет лежать токен;
   - `default_model` — модель/пресет сервиса («gpt-image-1», «sdxl» и т.д.);
   - `operations.generate` и `operations.edit` — конечные точки для генерации
     и редактирования (методы/пути можно оставить по умолчанию либо изменить).
3. Экспортируйте ключ:

```bash
export EXAMPLE_IMAGE_API_KEY="sk-..."
```

Пока vLLM не обращается к сервису напрямую, но конфиг уже используется как
whitelist: только при наличии файла разрешаются события
`response.image_generation_call.*` для текстовых моделей.

## 2. Запуск с конфигом

Передайте путь к файлу через CLI:

```bash
vllm serve openai/gpt-oss-120b \
  --host 0.0.0.0 \
  --port 8000 \
  --tensor-parallel-size 4 \
  --gpu-memory-utilization 0.90 \
  --max-model-len 65536 \
  --kv-cache-dtype auto \
  --async-scheduling \
  --image-service-config config/image_service.json
```

Если вместо `gpt-oss` используется мультимодальная модель (например, `phi-4-mm`),
опция не обязательна — сервер автоматически включает обработку встроенных
команд работы с изображениями.

## 3. Поведение без конфигурации

- Текстовые модели без `--image-service-config` больше не исполняют команды
  `image_generation.*`/`images.*`. Попытка вызова завершится SSE-событием
  `response.error` и записью в лог.
- Это позволяет безопасно запускать Responses API в окружениях, где внешние
  сервисы изображений недоступны.
- Как только конфиг будет указан, сервер выводит строку
  `External image service configured: <provider>` в лог и разрешает события.

## 4. Что дальше

Файл конфигурации уже содержит всю мета-информацию, необходимую для будущей
интеграции с реальными API (маршруты, ключи, модель). Когда реализация
вызовов появится (этап M6), обновлять серверные флаги не придётся — достаточно
будет заполнить реальные значения в уже существующем файле.
