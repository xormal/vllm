# Руководство по лимитам запросов/тул‑аутпутов

## Параметры командной строки

- `--max-request-body-bytes`: ограничивает размер входного JSON (в байтах).
- `--max-request-body-tokens`: ограничивает количество токенов в промпте (после шаблона). Если не указано, используется длина контекста модели.
- `--max-tool-output-bytes`: ограничивает длину тела в `POST /responses/{id}/tool_outputs`.
- `--max-stream-event-bytes`: ограничивает размер одного SSE события (байты в `data:` секции).
- `--responses-stream-buffer-max-bytes`: суммарный лимит на объём событий в памяти для одного стримингового запроса.

Пример:
```bash
python -m vllm.entrypoints.openai.api_server \
  --model <MODEL> \
  --max-request-body-bytes 1048576 \
  --max-request-body-tokens 8000 \
  --max-tool-output-bytes 131072 \
  --max-stream-event-bytes 524288 \
  --responses-stream-buffer-max-bytes 16777216
```

## Как работает

- При `POST /v1/responses` сервер сериализует запрос и проверяет:
  1. Размер JSON (байты) ≤ `max-request-body-bytes`.
  2. Количество токенов в промпте ≤ `max-request-body-tokens` (если задано; иначе ориентируемся на `max_model_len`).
- Если лимит превышен, возвращается 400 `invalid_request_error`.
- `tool_outputs` проверяются так же; превышение — 400 + предупреждение в логах.
- Каждое SSE событие сериализуется в JSON, и если оно превышает `max-stream-event-bytes`, поток завершается `response.error`, чтобы клиент не получал многомегабайтные чанки.
- Общий буфер на сеанс контролируется `responses-stream-buffer-max-bytes`. Если накопленный объём превышает лимит, генерация прерывается и в логах появляется предупреждение с подсказкой уменьшить `max_output_tokens` или отключить лимит для локального использования.

## Рекомендации

- Для локальных LLM с большим контекстом можно отключить лимиты (по умолчанию они не заданы).
- Для публичного сервера задайте значения чуть меньше контекста модели (например, 32k → лимит 30k токенов), чтобы пользователи не загружали запросы, которые модель всё равно не обработает.
- При стриминге используйте `max-stream-event-bytes` ~0.5–1 МБ, а `responses-stream-buffer-max-bytes` ≈ 16–64 МБ в зависимости от памяти узла. Значение `0` отключает лимит, но пригодно только для доверенных пользователей.
